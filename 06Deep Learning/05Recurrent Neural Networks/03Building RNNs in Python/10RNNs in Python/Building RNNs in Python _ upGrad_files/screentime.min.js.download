screentime=function(i){(i=$.extend({},{fields:[],preventEmptyCallback:!1,percentOnScreen:"50%",reportInterval:10,googleAnalytics:!1,callback:function(){}},i)).percentOnScreen=parseInt(i.percentOnScreen.replace("%",""),10);var t,e,n={},s={},c=null,o=null,l={},h=null,a=!1;function r(i){this.selector=i.selector,$elem=this.$elem=$(i.selector),this.name=i.name,this.top=$elem.offset().top,this.height=$elem.height(),this.bottom=this.top+this.height,this.width=$elem.width()}function f(){var i=$(window);this.top=i.scrollTop(),this.height=i.height(),this.bottom=this.top+this.height,this.width=i.width()}function p(){$.each(s,function(i,t){l[i]=0,n[i]=0})}function d(){var t=new f;$.each(s,function(e,s){"none"!=$(s.selector).css("display")&function(t,e){var n;return e.bottom<=t.bottom&&e.top>=t.top||!(e.bottom<t.top||e.top>t.bottom)&&(e.height>t.height?t.bottom-e.top>=t.height&&e.bottom-t.top>=t.height:(n=e.height*(i.percentOnScreen/100),t.bottom-n>=e.top&&e.bottom-n>t.top))}(t,s)&&(l[e]+=1,n[e]+=1)})}function u(){var s={};o&&c&&(s.inactiveTime=(o-c)/1e3),o=null,c=null,$.each(n,function(c,o){var l,h;o>0&&(s[c]=o,n[c]=0,i.googleAnalytics&&(l=c,h=o,t&&ga("send","event","Screentime","Time on Screen",l,parseInt(h,10),{nonInteraction:!0}),e&&_gaq.push(["_trackEvent","Screentime","Time on Screen",l,parseInt(h,10),!0])))}),$.isEmptyObject(s)&&i.preventEmptyCallback||i.callback.call(this,s,l)}function v(){$.each(i.fields,function(i,t){if($(t.selector).length){var e=new r(t);s[e.name]=e}}),p(),d()}function g(){a||(v(),a=!0),h=setInterval(function(){v()},1e3),reporter=setInterval(function(){u()},1e3*i.reportInterval)}function m(){clearInterval(h),clearInterval(reporter)}!i.fields.length&&i.preventEmptyCallback||(i.googleAnalytics&&("function"==typeof ga&&(t=!0),"undefined"!=typeof _gaq&&"function"==typeof _gaq.push&&(e=!0)),function(){window.visibly={q:document,p:void 0,prefixes:["webkit","ms","o","moz","khtml"],props:["VisibilityState","visibilitychange","Hidden"],m:["focus","blur"],visibleCallbacks:[],hiddenCallbacks:[],genericCallbacks:[],_callbacks:[],cachedPrefix:"",fn:null,onVisible:function(i){"function"==typeof i&&this.visibleCallbacks.push(i)},onHidden:function(i){"function"==typeof i&&this.hiddenCallbacks.push(i)},getPrefix:function(){if(!this.cachedPrefix)for(var i=0;b=this.prefixes[i++];)if(b+this.props[2]in this.q)return this.cachedPrefix=b,this.cachedPrefix},visibilityState:function(){return this._getProp(0)},hidden:function(){return this._getProp(2)},visibilitychange:function(i){"function"==typeof i&&this.genericCallbacks.push(i);var t=this.genericCallbacks.length;if(t)if(this.cachedPrefix)for(;t--;)this.genericCallbacks[t].call(this,this.visibilityState());else for(;t--;)this.genericCallbacks[t].call(this,arguments[0])},isSupported:function(i){return this.cachedPrefix+this.props[2]in this.q},_getProp:function(i){return this.q[this.cachedPrefix+this.props[i]]},_execute:function(i){if(i){this._callbacks=1==i?this.visibleCallbacks:this.hiddenCallbacks;for(var t=this._callbacks.length;t--;)this._callbacks[t]()}},_visible:function(){window.visibly._execute(1),window.visibly.visibilitychange.call(window.visibly,"visible")},_hidden:function(){window.visibly._execute(2),window.visibly.visibilitychange.call(window.visibly,"hidden")},_nativeSwitch:function(){this[this._getProp(2)?"_hidden":"_visible"]()},_listen:function(){try{this.isSupported()?this.q.addEventListener(this.cachedPrefix+this.props[1],function(){window.visibly._nativeSwitch.apply(window.visibly,arguments)},1):this.q.addEventListener?(window.addEventListener(this.m[0],this._visible,1),window.addEventListener(this.m[1],this._hidden,1)):this.q.attachEvent&&(this.q.attachEvent("onfocusin",this._visible),this.q.attachEvent("onfocusout",this._hidden))}catch(i){}},init:function(){this.getPrefix(),this._listen()}},this.visibly.init()}(),screentime.reset=function(){m(),p(),g()},screentime.destroy=function(){m(),p(),i.fields=[],i.preventEmptyCallback=!0},g(),visibly.onHidden(function(){c=(new Date).getTime(),m()}),visibly.onVisible(function(){!i.fields.length&&i.preventEmptyCallback||(o=(new Date).getTime(),m(),g())}))};